---
import { type Locale, useTranslations } from "@i18n/index";
import { SITE_URLS } from "@lib/urls";

const { locale } = Astro.props as { locale: Locale };
const t = useTranslations(locale);
const prefix = locale === "es" ? "/es" : "";

const navLinks = [
  { key: "library", href: `${prefix}/library`, label: t("nav.library"), external: false },
  { key: "docs", href: SITE_URLS.docs, label: t("nav.docs"), external: true },
  { key: "lab", href: SITE_URLS.lab, label: t("nav.lab"), external: true },
  { key: "build", href: SITE_URLS.build, label: t("nav.build"), external: true },
];

const menuOpenLabel = locale === "es" ? "Abrir menu" : "Open menu";
const menuCloseLabel = locale === "es" ? "Cerrar menu" : "Close menu";
const menuTitle = locale === "es" ? "Navegacion" : "Navigation";
---

<header class="sticky top-0 z-50 border-b border-white/6 bg-surface-950/80 backdrop-blur-xl">
  <div class="container-xl flex items-center justify-between h-14">
    <a href={`${prefix}/`} class="flex items-center gap-2 font-bold text-sm">
      <span class="text-brand-400 text-lg">✦</span>
      <span class="text-white">StealThis</span>
      <span class="text-slate-500">.dev</span>
    </a>

    <nav class="hidden sm:flex items-center gap-1" aria-label="Main navigation">
      {navLinks.map((link) => (
        <a
          href={link.href}
          class="nav-link"
          target={link.external ? "_blank" : undefined}
          rel={link.external ? "noopener" : undefined}
        >
          {link.label}
        </a>
      ))}
    </nav>

    <div class="flex items-center gap-2">
      <button
        class="hidden sm:inline-flex text-xs font-medium text-slate-400 hover:text-slate-200 transition-colors px-2 py-1 rounded-md hover:bg-white/6"
        aria-label="Toggle language"
        data-locale={locale}
        data-lang-toggle
      >
        {t("lang.toggle")}
      </button>

      <a
        href="https://github.com/Foodhy/stealthis"
        target="_blank"
        rel="noopener noreferrer"
        class="hidden sm:flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 rounded-lg bg-white/6 border border-white/10 text-slate-300 hover:bg-white/10 hover:text-white transition-colors"
        aria-label="GitHub"
      >
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"></path>
        </svg>
        GitHub
      </a>

      <button
        type="button"
        class="mobile-menu-trigger inline-flex items-center justify-center w-9 h-9 rounded-lg border border-white/10 bg-white/5 text-slate-300 hover:text-white hover:bg-white/10 transition-colors"
        aria-label={menuOpenLabel}
        aria-controls="mobile-nav-drawer"
        aria-expanded="false"
        data-mobile-menu-button
      >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="4" y1="7" x2="20" y2="7"></line>
          <line x1="4" y1="12" x2="20" y2="12"></line>
          <line x1="4" y1="17" x2="20" y2="17"></line>
        </svg>
      </button>
    </div>
  </div>
</header>

<div class="mobile-drawer sm:hidden" data-mobile-menu hidden>
  <button type="button" class="mobile-drawer__backdrop" data-mobile-close aria-label={menuCloseLabel}></button>
  <aside
    id="mobile-nav-drawer"
    class="mobile-drawer__panel"
    role="dialog"
    aria-modal="true"
    aria-label={menuTitle}
    data-mobile-drawer
    tabindex="-1"
  >
    <div class="mobile-drawer__header">
      <p class="mobile-drawer__title">{menuTitle}</p>
      <button type="button" class="mobile-drawer__close" data-mobile-close aria-label={menuCloseLabel}>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="6" y1="6" x2="18" y2="18"></line>
          <line x1="18" y1="6" x2="6" y2="18"></line>
        </svg>
      </button>
    </div>

    <nav class="mobile-drawer__nav" aria-label={menuTitle}>
      {navLinks.map((link) => (
        <a
          href={link.href}
          class="mobile-drawer__link"
          target={link.external ? "_blank" : undefined}
          rel={link.external ? "noopener" : undefined}
          data-mobile-close
        >
          <span class="mobile-drawer__link-main">
            <span class="mobile-drawer__icon" aria-hidden="true">
              {link.key === "library" && (
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 6.5a2.5 2.5 0 0 1 2.5-2.5H20v15H6.5A2.5 2.5 0 0 0 4 21.5z"></path>
                  <path d="M8 4v15"></path>
                </svg>
              )}
              {link.key === "docs" && (
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                  <polyline points="14 3 14 9 20 9"></polyline>
                </svg>
              )}
              {link.key === "lab" && (
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10 2v5l-5.5 9.5A2 2 0 0 0 6.2 20h11.6a2 2 0 0 0 1.7-3.5L14 7V2"></path>
                  <path d="M8.5 13h7"></path>
                </svg>
              )}
              {link.key === "build" && (
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="8" height="8" rx="1.5"></rect>
                  <rect x="13" y="3" width="8" height="8" rx="1.5"></rect>
                  <rect x="8" y="13" width="8" height="8" rx="1.5"></rect>
                </svg>
              )}
            </span>
            <span>{link.label}</span>
          </span>
          <span aria-hidden="true">↗</span>
        </a>
      ))}
      <a
        href="https://github.com/Foodhy/stealthis"
        target="_blank"
        rel="noopener noreferrer"
        class="mobile-drawer__link"
        data-mobile-close
      >
        <span class="mobile-drawer__link-main">
          <span class="mobile-drawer__icon" aria-hidden="true">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"></path>
            </svg>
          </span>
          <span>GitHub</span>
        </span>
        <span aria-hidden="true">↗</span>
      </a>
    </nav>

    <button
      type="button"
      class="mobile-drawer__lang"
      aria-label="Toggle language"
      data-locale={locale}
      data-lang-toggle
      data-mobile-close
    >
      {t("lang.toggle")}
    </button>
  </aside>
</div>

<style>
  .nav-link {
    @apply text-sm font-medium text-slate-400 hover:text-slate-100 transition-colors px-3 py-1.5 rounded-lg hover:bg-white/6;
  }

  .mobile-menu-trigger {
    display: inline-flex;
  }

  @media (min-width: 640px) {
    .mobile-menu-trigger {
      display: none !important;
    }
  }

  .mobile-drawer {
    position: fixed;
    inset: 0;
    z-index: 80;
  }

  .mobile-drawer__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(2, 6, 23, 0.72);
    opacity: 0;
    transition: opacity 200ms ease;
    border: 0;
  }

  .mobile-drawer__panel {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    width: min(86vw, 20rem);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
    border-left: 1px solid rgba(103, 183, 255, 0.24);
    background:
      radial-gradient(circle at 25% 18%, rgba(103, 183, 255, 0.23), transparent 38%),
      radial-gradient(circle at 78% 82%, rgba(149, 117, 255, 0.22), transparent 44%),
      linear-gradient(180deg, rgba(10, 18, 42, 0.97), rgba(7, 12, 28, 0.97));
    backdrop-filter: blur(14px);
    transform: translateX(100%);
    transition: transform 220ms cubic-bezier(0.2, 0.8, 0.2, 1);
    outline: none;
  }

  .mobile-drawer__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.09);
  }

  .mobile-drawer__title {
    margin: 0;
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: rgb(158 177 224);
  }

  .mobile-drawer__close {
    width: 2rem;
    height: 2rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.04);
    color: rgb(203 213 225);
  }

  .mobile-drawer__nav {
    display: grid;
    gap: 0.55rem;
  }

  .mobile-drawer__link-main {
    display: inline-flex;
    align-items: center;
    gap: 0.58rem;
  }

  .mobile-drawer__icon {
    width: 1.55rem;
    height: 1.55rem;
    border-radius: 0.45rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: rgb(188 214 255);
    border: 1px solid rgba(103, 183, 255, 0.34);
    background: linear-gradient(135deg, rgba(103, 183, 255, 0.2), rgba(149, 117, 255, 0.2));
    flex-shrink: 0;
  }

  .mobile-drawer__link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    text-decoration: none;
    color: rgb(233 240 255);
    padding: 0.7rem 0.8rem;
    border-radius: 0.7rem;
    border: 1px solid rgba(129, 161, 237, 0.31);
    background: linear-gradient(90deg, rgba(80, 129, 245, 0.12), rgba(92, 80, 198, 0.1));
    font-size: 0.92rem;
    font-weight: 500;
    transition: background 160ms ease, border-color 160ms ease, color 160ms ease;
  }

  .mobile-drawer__link:hover {
    color: rgb(255 255 255);
    background: linear-gradient(90deg, rgba(96, 155, 255, 0.2), rgba(133, 98, 255, 0.2));
    border-color: rgba(112, 164, 255, 0.52);
  }

  .mobile-drawer__lang {
    margin-top: auto;
    width: 100%;
    border-radius: 0.75rem;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.05);
    color: rgb(226 232 240);
    font-size: 0.84rem;
    font-weight: 600;
    padding: 0.72rem 0.9rem;
    text-align: center;
  }

  .mobile-drawer.is-open .mobile-drawer__backdrop {
    opacity: 1;
  }

  .mobile-drawer.is-open .mobile-drawer__panel {
    transform: translateX(0);
  }

  :global(body.mobile-nav-open) {
    overflow: hidden;
  }
</style>

<script>
  const toggleLanguage = (locale) => {
    const path = window.location.pathname;

    if (locale === "en") {
      localStorage.setItem("stealthis:locale", "es");
      window.location.href = `/es${path}`;
      return;
    }

    localStorage.setItem("stealthis:locale", "en");
    window.location.href = path.replace(/^\/es(?=\/|$)/, "") || "/";
  };

  document.querySelectorAll("[data-lang-toggle]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const locale = btn.dataset.locale === "en" ? "en" : "es";
      toggleLanguage(locale);
    });
  });

  const menuButton = document.querySelector("[data-mobile-menu-button]");
  const menu = document.querySelector("[data-mobile-menu]");
  const menuPanel = menu?.querySelector("[data-mobile-drawer]");
  const closeTriggers = menu?.querySelectorAll("[data-mobile-close]");
  const mq = window.matchMedia("(min-width: 640px)");

  const closeMenu = (immediate = false) => {
    if (!(menu instanceof HTMLElement)) return;
    if (!(menuButton instanceof HTMLElement)) return;

    menu.classList.remove("is-open");
    menuButton.setAttribute("aria-expanded", "false");
    document.body.classList.remove("mobile-nav-open");

    if (immediate) {
      menu.hidden = true;
      return;
    }

    window.setTimeout(() => {
      if (!menu.classList.contains("is-open")) menu.hidden = true;
    }, 220);
  };

  const openMenu = () => {
    if (!(menu instanceof HTMLElement)) return;
    if (!(menuButton instanceof HTMLElement)) return;

    menu.hidden = false;
    menuButton.setAttribute("aria-expanded", "true");
    document.body.classList.add("mobile-nav-open");

    requestAnimationFrame(() => {
      menu.classList.add("is-open");
      if (menuPanel instanceof HTMLElement) menuPanel.focus();
    });
  };

  if (menuButton instanceof HTMLButtonElement && menu instanceof HTMLElement) {
    menuButton.addEventListener("click", () => {
      const expanded = menuButton.getAttribute("aria-expanded") === "true";
      if (expanded) {
        closeMenu();
      } else {
        openMenu();
      }
    });
  }

  closeTriggers?.forEach((el) => {
    el.addEventListener("click", () => closeMenu());
  });

  window.addEventListener("keydown", (event) => {
    if (event.key === "Escape") closeMenu();
  });

  mq.addEventListener("change", (event) => {
    if (event.matches) closeMenu(true);
  });
</script>
